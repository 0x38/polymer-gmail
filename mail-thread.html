<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-icon/core-icon.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="profile-img.html">
<link rel="import" href="swipeable-item.html">

<!--
A single GMail mail thread.

##### Example

    <mail-thread></mail-thread>

@element mail-thread
@extends swipeable-item
-->
<polymer-element name="mail-thread" extends="swipeable-item" attributes="messages narrow selected profile archived undo">
  <template>
    <core-style ref="swipeable"></core-style>
    <style>
      :host {
        display: block;
        background-color: #757575;
        transition: max-height 200ms ease-in-out 200ms;
        max-height: 120px; /* bigger than thread can ever be. */
      }
      :host(.shrink) {
        max-height: 0;
      }
      :host([selected]) #thread {
        background-color: #eee;
      }
      :host([narrow]) #actionicons {
        display: none;
      }
      :host([archived][undo]) #archived {
        opacity: 1;
        transition: opacity 200ms ease-in-out 400ms;
      }
      #container {
        position: relative;
        z-index: 0;
      }
      #thread {
        background-color: #fafafa;
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
        will-change: transform, opacity;
      }
      #thread.pressing {
        background-color: #e0e0e0;
      }
      #lastline,
      #actionicons {
        color: #9e9e9e;
      }
      .messagecount {
        font-weight: 400;
        color: #9e9e9e;
        margin-left: 5px;
      }
      header {
        margin-left: 16px;
        font-size: 14px;
      }
      header span.name {
        font-size: 18px;
        font-weight: 500;
      }
      header span.subject {
        font-weight: 500;
        margin: 6px 0;
      }
      header span.snippet,
      header span.subject,
      header span.name {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        max-width: 90%;
      }
      header span.name {
        max-width: 80%;
      }
      time {
        font-size: 12px;
        color: #03a9f4;
        font-weight: 400;
        letter-spacing: 1px;
        text-transform: uppercase;
      }
      .starred {
        color: #ffeb3b;
      }
      .undo {
        color: #ffa726;
        text-transform: uppercase;
      }
      .undo:active {
        background-color: #9e9e9e;
      }
      #archived {
        color: white;
        z-index: -1;
        opacity: 0;
        will-change: opacity;
      }
      #archived > * {
        padding: 16px;
      }
    </style>
    <div id="container" on-tap="{{onTap}}">
      <div id="thread" layout horizontal on-down="{{onDown}}" on-up="{{onUp}}"
                       on-hold="{{onHold}}">
        <profile-img id="profileimage" src="{{profile}}"
                     letter="{{thread.from.name[0]}}"
                     selected?="{{selected}}"></profile-img>
        <div flex layout horizontal>
          <header layout vertical flex>
            <span layout horizontal center justified>
              <span class="name">
                {{thread.from.name}}
                <template if="{{messages.length >= 2}}">
                  <span class="messagecount">{{messages.length}}</span>
                </template>
              </span>
              <time>{{thread.date}}</time>
            </span>
            <span class="subject">{{thread.subject}}</span>
            <span id="lastline" layout horizontal center justified>
              <span class="snippet" flex>{{thread.snippet | decodeHTMLEntitiesFilter}}</span>
              <core-icon id="star" icon="star{{starred ? '' : '-outline'}}" on-tap="{{onHighlightStar}}" class="{{ {starred: starred} | tokenList }}"></core-icon>
            </span>
          </header>
          <div id="actionicons" on-down="{{onMailAction}}" on-hold="{{onMailAction}}" self-start>
            <paper-icon-button icon="reply"></paper-icon-button>
            <paper-icon-button icon="reply-all"></paper-icon-button>
            <paper-icon-button icon="forward"></paper-icon-button>
            <paper-icon-button icon="more-vert"></paper-icon-button>
          </div>
        </div>
      </div>
      <div id="archived" layout horizontal center justified fit>
        <span>Archived</span>
        <span class="undo" on-tap="{{onUndo}}" layout horizontal center self-stretch>UNDO</span>
      </div>
    </div>
  </template>
  <script>
  Polymer({
    starred: false,

    /**
     * TThe list of messages the thread contains.
     *
     * @property message
     * @type array
     * @default []
     */

    /**
     * The profile information of the last person to reply in the thread.
     *
     * @attribute profile
     * @type object
     * @default null
     */

    publish: {
      /**
       * Signifies on a mobile devices. Used to render a more condensed UI.
       *
       * @attribute narrow
       * @type bool
       * @default false
       */
      narrow: {value: false, reflect: true},

      /**
       * If the thread is selected by the user.
       *
       * @attribute selected
       * @type bool
       * @default false
       */
      selected: {value: false, reflect: true},

      /**
       * True if the thread is archived.
       *
       * @attribute archived
       * @type bool
       * @default false
       */
      archived: {value: false, reflect: true},

      /**
       * True if the thread should show its undo UI.
       *
       * @attribute undo
       * @type bool
       * @default false
       */
      undo: {value: false, reflect: true}
    },

    created: function() {
      this.messages = [];
      this.profile = null;
    },
    domReady: function() {
      this.target = this.$.thread; // set before calling super().
      this.super();
    },
    messagesChanged: function() {
      // TODO: support all messages in thread.
      this.thread = this.messages[this.messages.length - 1];
    },
    decodeHTMLEntitiesFilter: function(val) {
      var t = document.createElement('textarea');
      t.innerHTML = val;
      return t.textContent;
    },
    onHighlightStar: function(e, detail, sender) {
      this.starred = !this.starred;
      e.stopPropagation();
    },
    onMailAction: function(e, detail, sender) {
      e.stopPropagation();
    },
    onUndo: function() {
      this.swipe(false);
    },
    onDown: function(e, detail, sender) {
      if (e.target == this.$.profileimage || e.target == this.$.star) {
        return;
      }
      this.$.thread.classList.add('pressing');
    },
    onUp: function(e, detail, sender) {
      this.$.thread.classList.remove('pressing');
    },
    onHold: function(e, detail, sender) {
      // If the profile image is the target ignore. onTap() will handle it.
      if (e.target == this.$.profileimage || e.target == this.$.star) {
        return;
      }
      this.selected = !this.selected;
      this.$.profileimage.fire('tap');
    },
    onTap: function(e, detail, sender) {
      if (e.target != this.$.profileimage) {
        // Profile image is the only thing that selects a thread.
        e.stopPropagation();
      }
    },
    swipeOffChanged: function() {
      // Show in-place UNDO for a swipe. Don't show it for multi-select archive.
      this.undo = this.swipeOff;// && !this.archived;
      this.archived = this.swipeOff;
    },
    archivedChanged: function(e) {
      if (this.archived) {

        // De-select thread.
        if (this.selected) {
          this.selected = false;
          this.$.profileimage.fire('tap'); // tell core-selector.
        }

        // TODO: don't do this here. Should be handled by swipeable-item
        this.target.classList.add('offscreen', 'right');
        if (!this.undo) {
          this.async(function() {
            this.classList.add('shrink');
          });
        }
      } else {
        this.target.classList.remove('offscreen', 'right');
        this.classList.remove('shrink');
      }
    }
  });
</script>
</polymer-element>