<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-icon/core-icon.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">


<polymer-element name="profile-img" attributes="src letter" noscript>
  <template>
    <style>
        .profile {
          border-radius: 50%;
          width: 40px;
          height: 40px;
          transition: transform 350ms ease-in-out;
          background-color: #9e9e9e;
          color: white;
          will-change: transform;
        }
        :host(.selected) .profile {
          transform: rotate3d(0,1,0,180deg);
        }
        :host(.selected) img,
        :host(.selected) .letter {
          opacity: 0;
        }
        img,
        .letter {
          border-radius: inherit;
          width: 100%;
          height: 100%;
          transition: opacity 200ms ease-in-out 100ms;
          will-change: opacity;
        }
        core-icon {
          transition: transform 300ms ease-in-out 100ms;
          will-change: opacity;
          transform: rotate3d(0,1,0,-180deg) scale(0);
          position: absolute !important;
          top: 20%;
          left: 20%;
          opacity: 0;
        }
        :host(.selected) core-icon {
          transform: rotate3d(0,1,0,-180deg) scale(1);
          opacity: 1;
        }
    </style>
    <div class="profile">
      <template if="{{src}}"><img src="{{src}}"></template>
      <template if="{{!src}}">
        <span class="letter" layout horizontal center-center>{{letter}}</span>
      </template>
      <core-icon icon="check"></core-icon>
    </div>
   </template>
</polymer-element>

<polymer-element name="mail-thread" attributes="messages narrow selected profile">
  <template>
    <style>
      :host {
        display: block;
      }
      :host([selected]) {
        background-color: #eee;
      }
      :host([narrow]) #actionicons {
        display: none;
      }
      #thread {
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
      }
      #lastline,
      #actionicons {
        color: #9e9e9e;
      }
      .messagecount {
        font-weight: 400;
        color: #9e9e9e;
        margin-left: 5px;
      }
      header {
        margin-left: 16px;
        font-size: 14px;
      }
      header span.name {
        font-size: 18px;
        font-weight: 500;
      }
      header span.subject {
        font-weight: 500;
        margin: 6px 0;
      }
      header span.snippet,
      header span.subject,
      header span.name {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        max-width: 90%;
      }
      header span.name {
        max-width: 80%;
      }
      time {
        font-size: 12px;
        color: #03a9f4;
        font-weight: 400;
        letter-spacing: 1px;
        text-transform: uppercase;
      }
      .starred {
        color: #ffeb3b;
      }
    </style>
    <div id="thread" layout horizontal>
      <profile-img src="{{profile}}" letter="{{thread.from.name[0]}}" on-tap="{{toggleThreadSelected}}"></profile-img>
      <div flex layout horizontal>
        <header layout vertical flex>
          <span layout horizontal center justified>
            <span class="name">
              {{thread.from.name}}
              <template if="{{messages.length >= 2}}"><span class="messagecount">{{messages.length}}</span></template>
            </span>
            <time>{{thread.date}}</time>
          </span>
          <span class="subject">{{thread.subject}}</span>
          <span id="lastline" layout horizontal center justified>
            <span class="snippet" flex>{{thread.snippet | decodeHTMLEntitiesFilter}}</span>
            <core-icon icon="star{{starred ? '' : '-outline'}}" on-tap="{{onHighlightStar}}"
                       class="{{ {starred: starred} | tokenList }}"></core-icon>
          </span>
        </header>
        <div id="actionicons" on-tap="{{onMailAction}}" self-start>
          <paper-icon-button icon="reply"></paper-icon-button>
          <paper-icon-button icon="reply-all"></paper-icon-button>
          <paper-icon-button icon="forward"></paper-icon-button>
          <paper-icon-button icon="more-vert"></paper-icon-button>
        </div>
      </div>
    </div>
  </template>
  <script>
  Polymer({
    starred: false,
    publish: {
      narrow: {value: false, reflect: true},
      selected: {value: false, reflect: true}
    },
    created: function() {
      this.messages = [];
    },
    messagesChanged: function() {
      this.thread = this.messages[0]; // TODO: support all messages in thread.
    },
    onHighlightStar: function(e, detail, sender) {
      this.starred = !this.starred;
      e.stopPropagation();
    },
    onMailAction: function(e, detail, sender) {
      e.stopPropagation();
    },
    toggleThreadSelected: function(e, detail, sender) {
      sender.classList.toggle('selected');
    },
    decodeHTMLEntitiesFilter: function(val) {
      var t = document.createElement('textarea');
      t.innerHTML = val;
      return t.textContent;
    }
  });
</script>
</polymer-element>