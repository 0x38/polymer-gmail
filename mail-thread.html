<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-icon/core-icon.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">


<polymer-element name="profile-img" attributes="src letter" noscript>
  <template>
    <style>
      .profile {
        border-radius: 50%;
        width: 40px;
        height: 40px;
        transition: transform 350ms ease-in-out;
        background-color: #9e9e9e;
        color: white;
        will-change: transform;
      }
      :host([selected]) .profile {
        transform: rotate3d(0,1,0,180deg);
      }
      :host([selected]) img,
      :host([selected]) .letter {
        opacity: 0;
      }
      :host([selected]) core-icon {
        transform: rotate3d(0,1,0,-180deg) scale(1);
        opacity: 1;
      }
      img,
      .letter {
        border-radius: inherit;
        width: 100%;
        height: 100%;
        transition: opacity 200ms ease-in-out 100ms;
        will-change: opacity;
        text-transform: uppercase;
      }
      core-icon {
        transition: transform 300ms ease-in-out 100ms;
        will-change: opacity;
        transform: rotate3d(0,1,0,-180deg) scale(0);
        position: absolute !important;
        top: 20%;
        left: 20%;
        opacity: 0;
      }
    </style>
    <div class="profile">
      <template if="{{src}}"><img src="{{src}}"></template>
      <template if="{{!src}}">
        <span class="letter" layout horizontal center-center>{{letter}}</span>
      </template>
      <core-icon icon="check"></core-icon>
    </div>
   </template>
</polymer-element>

<polymer-element name="mail-thread" attributes="messages narrow selected profile">
  <template>
    <style>
      :host {
        display: block;
        background-color: #757575;
      }
      :host([selected]) #thread {
        background-color: #eee;
      }
      :host([narrow]) #actionicons {
        display: none;
      }
      #container {
        position: relative;
        z-index: 0;
      }
      #thread {
        background-color: #fafafa;
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
        will-change: transform, opacity;
      }
      #thread.pressing {
        background-color: #e0e0e0;
      }
      #thread.snapback {
        transition: all 300ms ease-in-out;
        transform: none !important;
        opacity: 1 !important;
      }
      #thread.archive {
        transition: all 300ms linear;
        opacity: 0 !important;
      }
      #lastline,
      #actionicons {
        color: #9e9e9e;
      }
      .messagecount {
        font-weight: 400;
        color: #9e9e9e;
        margin-left: 5px;
      }
      header {
        margin-left: 16px;
        font-size: 14px;
      }
      header span.name {
        font-size: 18px;
        font-weight: 500;
      }
      header span.subject {
        font-weight: 500;
        margin: 6px 0;
      }
      header span.snippet,
      header span.subject,
      header span.name {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        max-width: 90%;
      }
      header span.name {
        max-width: 80%;
      }
      time {
        font-size: 12px;
        color: #03a9f4;
        font-weight: 400;
        letter-spacing: 1px;
        text-transform: uppercase;
      }
      .starred {
        color: #ffeb3b;
      }
      .undo {
        color: #ffa726;
        text-transform: uppercase;
      }
      .undo:active {
        background-color: #9e9e9e;
      }
      #archived {
        color: white;
        z-index: -1;
        opacity: 0;
        will-change: opacity;
      }
      #archived > * {
        padding: 16px;
      }
      #archived.show {
        opacity: 1;
        transition: opacity 200ms ease-in-out 400ms;
      }
    </style>
    <div id="container" on-tap="{{onTap}}">
        <div id="thread" layout horizontal touch-action="pan-y"
                       on-track="{{onTrack}}"
                       on-trackend="{{onTrackEnd}}" 
                       on-down="{{onDown}}" on-up="{{onUp}}"
                       on-hold="{{onHold}}"
                       on-transitionend="{{onSnapedBack}}">
        <profile-img id="profileimage" src="{{profile}}"
                     letter="{{thread.from.name[0]}}"
                     selected?="{{selected}}"></profile-img>
        <div flex layout horizontal>
          <header layout vertical flex>
            <span layout horizontal center justified>
              <span class="name">
                {{thread.from.name}}
                <template if="{{messages.length >= 2}}">
                  <span class="messagecount">{{messages.length}}</span>
                </template>
              </span>
              <time>{{thread.date}}</time>
            </span>
            <span class="subject">{{thread.subject}}</span>
            <span id="lastline" layout horizontal center justified>
              <span class="snippet" flex>{{thread.snippet | decodeHTMLEntitiesFilter}}</span>
              <core-icon id="star" icon="star{{starred ? '' : '-outline'}}" on-tap="{{onHighlightStar}}" class="{{ {starred: starred} | tokenList }}"></core-icon>
            </span>
          </header>
          <div id="actionicons" on-down="{{onMailAction}}" on-hold="{{onMailAction}}" self-start>
            <paper-icon-button icon="reply"></paper-icon-button>
            <paper-icon-button icon="reply-all"></paper-icon-button>
            <paper-icon-button icon="forward"></paper-icon-button>
            <paper-icon-button icon="more-vert"></paper-icon-button>
          </div>
        </div>
      </div>
      <div id="archived" layout horizontal center justified fit>
        <span>Archived</span>
        <span class="undo" on-tap="{{onUndo}}" layout horizontal center self-stretch>UNDO</span>
      </div>
    </div>
  </template>
  <script>
  Polymer({
    starred: false,
    archive: false,
    sliding: 0, // -1: sliding left, 0: not sliding, 1: sliding right
    SWIPE_THREASHOLD: 10,
    publish: {
      narrow: {value: false, reflect: true},
      selected: {value: false, reflect: true}
    },
    created: function() {
      this.messages = [];
    },
    domReady: function() {
      this.width = this.$.thread.clientWidth; // cache it.
    },
    messagesChanged: function() {
      // TODO: support all messages in thread.
      this.thread = this.messages[this.messages.length - 1];
    },
    decodeHTMLEntitiesFilter: function(val) {
      var t = document.createElement('textarea');
      t.innerHTML = val;
      return t.textContent;
    },
    onHighlightStar: function(e, detail, sender) {
      this.starred = !this.starred;
      e.stopPropagation();
    },
    onMailAction: function(e, detail, sender) {
      e.stopPropagation();
    },
    onUndo: function() {
      this.archive = false;
    },
    onDown: function(e, detail, sender) {
      if (e.target == this.$.profileimage || e.target == this.$.star) {
        return;
      }
      this.$.thread.classList.add('pressing');
    },
    onUp: function(e, detail, sender) {
      this.$.thread.classList.remove('pressing');
    },
    onHold: function(e, detail, sender) {
      // If the profile image is the target ignore. onTap() will handle it.
      if (e.target == this.$.profileimage || e.target == this.$.star) {
        return;
      }
      this.selected = !this.selected;
      this.$.profileimage.fire('tap');
    },
    onTap: function(e, detail, sender) {
      if (e.target != this.$.profileimage) {
        // Profile image is the only thing that selects a thread.
        e.stopPropagation();
      }
    },
    onTrack: function(e, detail, sender) {
      this.sliding = e.xDirection;
      this.last_ddx = e.ddx;

      var style = this.$.thread.style;
      style.transform = 'translateX(' + e.dx + 'px)';
      style.opacity = 1 - (Math.abs(e.dx) / this.width);
    },
    onTrackEnd: function(e, detail, sender) {
      // Archive the message if the swipe was fast.
      if (Math.abs(this.last_ddx) > this.SWIPE_THREASHOLD) {
        this.archive = true;

        var time = 100;//(this.sliding * this.width) / this.last_ddx / 0.1;
        this.$.thread.style.transition = 'all ' + time + 'ms linear';
        return;
      }

      // Slide all the way off (left/right) if we're 50% slide.
      if (Math.abs(e.dx) >= this.width / 2) {
        this.archive = true;
      } else {
        this.$.thread.classList.add('snapback');
      }
    },
    archiveChanged: function() {
      this.$.archived.classList.toggle('show', this.archive);

      if (this.archive) {
        //this.$.thread.style.transform = 'translateX(' + (e.xDirection * this.width) + 'px)';
        //this.$.thread.style.transform = 'translateX(' + (Math.sign(e.dx) * this.width) + 'px)';
        //this.$.thread.style.transform = 'translateX(' + this.width + 'px)';
        this.$.thread.classList.add('archive');
        this.$.thread.style.transform = 'translateX(' + (this.sliding * this.width) + 'px)';

        if (this.selected) {
          this.selected = false;
          this.fire('tap'); // de-select item through core-selector.
        }

      } else {
        this.$.thread.style.transition = '';
        this.$.thread.style.transform = 'translateX(' + this.width + 'px)';
        this.$.thread.classList.remove('archive');
        this.async(function() {
          this.$.thread.classList.add('snapback');
        });
      }
    },
    onSnapedBack: function(e, detail, sender) {
      // If thread is archived, don't snap it back.
      if (this.$.thread.classList.contains('archive')) {
        return;
      }

      if (e.propertyName == 'transform') {
        var style = this.$.thread.style;
        style.transform = '';
        style.opacity = '';
        this.$.thread.classList.remove('snapback');
      }
    }
  });
</script>
</polymer-element>